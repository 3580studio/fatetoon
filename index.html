<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FATETOON | 만세력 계산기</title>
  <link rel="stylesheet" href="style.css" />
  <script src="script.js" defer></script>
</head>
<body>
  <header>
    <h1>🌕 FATETOON 만세력</h1>
    <small>사주를 쉽게, 만세력을 만화처럼</small>
  </header>

  <form id="saju-form">
    <label for="birthdate">생년월일 (양력)</label>
    <input type="date" id="birthdate" required />

    <label for="birthtime">태어난 시각</label>
    <select id="birthtime" required></select>

    <button type="submit">사주 계산하기</button>
  </form>

  <div id="result"></div>

  <script>
    /* ===== FATETOON 만세력 - 최종본 ===== */
    function calculateSaju() {
      const birthStr = document.getElementById("birthdate").value;
      const hourBranchIndex = parseInt(document.getElementById("birthtime").value);
      const resultEl = document.getElementById("result");

      if (!birthStr) {
        resultEl.innerHTML = "⚠️ 생년월일을 입력해주세요.";
        return;
      }

      const birthDate = new Date(birthStr + "T12:00:00");
      const y = birthDate.getFullYear();
      const m = birthDate.getMonth() + 1;
      const d = birthDate.getDate();

      const stems = ["갑","을","병","정","무","기","경","신","임","계"];
      const branches12 = ["자","축","인","묘","진","사","오","미","신","유","술","해"];

      const adjYear = (m < 2 || (m === 2 && d < 4)) ? y - 1 : y;
      const yearStem = stems[(adjYear - 4) % 10];
      const yearBranch = branches12[(adjYear - 4) % 12];
      const yearGanji = yearStem + yearBranch;

      const boundaries = {2:4,3:6,4:5,5:6,6:6,7:7,8:8,9:8,10:8,11:7,12:7,1:6};
      const monthOrder = {2:0,3:1,4:2,5:3,6:4,7:5,8:6,9:7,10:8,11:9,12:10,1:11};

      let monthBranchIdx;
      if (m === 1 && d < boundaries[1]) monthBranchIdx = 11;
      else {
        const usePrev = (d < boundaries[m]);
        const key = usePrev ? (m > 1 ? m - 1 : 12) : m;
        monthBranchIdx = monthOrder[key];
      }
      const monthBranches = ["인","묘","진","사","오","미","신","유","술","해","자","축"];
      const monthBranch = monthBranches[monthBranchIdx];

      const yearStemIdx = (adjYear - 4) % 10;
      let tigerStemIdx;
      if (yearStemIdx === 0 || yearStemIdx === 5) tigerStemIdx = 2;
      else if (yearStemIdx === 1 || yearStemIdx === 6) tigerStemIdx = 4;
      else if (yearStemIdx === 2 || yearStemIdx === 7) tigerStemIdx = 6;
      else if (yearStemIdx === 3 || yearStemIdx === 8) tigerStemIdx = 8;
      else tigerStemIdx = 0;

      const monthStem = stems[(tigerStemIdx + monthBranchIdx) % 10];
      const monthGanji = monthStem + monthBranch;

      const dayGanji = getDayGanjiJDN(y, m, d, stems, branches12);
      const dayStemIdx = stems.indexOf(dayGanji[0]);
      const hourStemIdx = (dayStemIdx * 2 + hourBranchIndex) % 10;
      const hourGanji = stems[hourStemIdx] + branches12[hourBranchIndex];

      resultEl.innerHTML = `
        <h3>🌕 당신의 사주 결과</h3>
        <p>년주: ${yearGanji}</p>
        <p>월주: ${monthGanji}</p>
        <p>일주: ${dayGanji}</p>
        <p>시주: ${hourGanji}</p>
      `;
    }

    function getDayGanjiJDN(y, m, d, stems, branches) {
      const jdnBase = JD(1984, 2, 2);
      const j = JD(y, m, d);
      const idx = (j - jdnBase + 2) % 60;
      return stems[idx % 10] + branches[idx % 12];
    }

    function JD(y, m, d) {
      const a = Math.floor((14 - m) / 12);
      const y2 = y + 4800 - a;
      const m2 = m + 12 * a - 3;
      return d + Math.floor((153 * m2 + 2) / 5) + 365 * y2 + Math.floor(y2 / 4)
           - Math.floor(y2 / 100) + Math.floor(y2 / 400) - 32045;
    }

    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("saju-form");
      form.addEventListener("submit", (e) => {
        e.preventDefault();
        calculateSaju();
      });
      const hourSelect = document.getElementById("birthtime");
      const branches = ["자","축","인","묘","진","사","오","미","신","유","술","해"];
      branches.forEach((b, i) => {
        const opt = document.createElement("option");
        opt.value = i;
        opt.text = `${b}시 (${(i * 2) % 24}:00)`;
        hourSelect.appendChild(opt);
      });
    });
  </script>
</body>
</html>
